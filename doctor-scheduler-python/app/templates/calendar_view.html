{% extends "layout.html" %}

{% block title %}
Xem Lịch trực
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='calendar.css') }}">
    <style>
        /* --- CSS Tùy chỉnh cho Thanh lọc --- */
        .calendar-toolbar {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0;
            white-space: nowrap;
        }

        /* Badge Vai trò */
        .role-badge {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 700;
            text-transform: uppercase;
            vertical-align: middle;
        }
        .role-main { 
            background-color: #e7f1ff; 
            color: #0d6efd; 
            border: 1px solid #0d6efd; 
        } 
        .role-sub { 
            background-color: #f8f9fa; 
            color: #6c757d; 
            border: 1px solid #6c757d; 
        }

        /* Tên Bác sĩ & Khoa */
        .doc-name { font-weight: 700; color: #212529; }
        .doc-clinic { font-size: 0.8em; color: #6c757d; display: block; margin-top: 2px; }

        /* Highlight cột Thứ 7, CN */
        .day-sat { background-color: #fff0f0 !important; color: #d63384; }
        .day-sun { background-color: #ffe6e6 !important; color: #dc3545; }

        /* Style cho ô bác sĩ trong chế độ xem theo ca */
        .doctor-badge {
            margin-bottom: 4px;
            transition: all 0.2s;
        }
        .doctor-badge:last-child {
            margin-bottom: 0;
        }
        
    </style>
{% endblock %}

{% block main %}
<div class="container-fluid mt-4">
    
    {% if not job %}
        <div class="alert alert-warning text-center p-5">
            <h4 class="alert-heading"><i class="bi bi-exclamation-circle"></i> Chưa có dữ liệu lịch trực!</h4>
            <p class="mb-4">Vui lòng quay lại bảng điều khiển và chạy một tác vụ xếp lịch trước khi xem kết quả.</p>
            <a href="{{ url_for('main.schedule_dashboard') }}" class="btn btn-warning btn-lg">
                <i class="bi bi-arrow-left-circle"></i> Quay lại Bảng điều khiển
            </a>
        </div>
    {% else %}
        
        <!-- Header: Tên Job và Trạng thái -->
        <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
            <div>
                <h3 class="mb-1 text-primary">
                    <i class="bi bi-calendar-week"></i> Lịch trực: {{ job.name }}
                </h3>
                <span class="text-muted small">
                    <i class="bi bi-clock"></i> Thời gian: 
                    <strong>{{ job.start_date.strftime('%d/%m/%Y') }}</strong> đến 
                    <strong>{{ job.end_date.strftime('%d/%m/%Y') }}</strong>
                </span>
            </div>
            <div>
                <span class="badge bg-success p-2"><i class="bi bi-check-circle-fill"></i> Đã hoàn thành</span>
            </div>
        </div>

        <!-- THANH CÔNG CỤ (TOOLBAR) -->
        <div class="calendar-toolbar">
            
            <!-- 1. Bộ lọc Khoa (Client-side) -->
            <div class="filter-group">
                <label for="clinicFilter" class="filter-label"><i class="bi bi-funnel-fill text-primary"></i> Lọc Khoa:</label>
                <select class="form-select form-select-sm" id="clinicFilter" onchange="filterSchedule()" style="min-width: 200px;">
                    <option value="all" selected>-- Hiển thị Tất cả --</option>
                    {% for clinic in clinics %}
                        <option value="clinic-{{ clinic.id }}">{{ clinic.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- 2. Bộ lọc Thời gian (Server-side) -->
            <div class="filter-group border-start ps-3">
                <label class="filter-label me-2"><i class="bi bi-eye text-success"></i> Chế độ xem:</label>
                
                <form action="{{ url_for('main.view_calendar', job_id=job.id) }}" method="GET" class="d-flex align-items-center gap-2">
                    <!-- Chọn ngày mốc -->
                    <input type="date" name="date" class="form-control form-control-sm" 
                           value="{{ current_date }}" 
                           title="Chọn ngày muốn xem" 
                           style="width: 130px;">
                    
                    <!-- Các nút chuyển chế độ -->
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="submit" name="view_mode" value="day" 
                                class="btn btn-outline-primary {% if current_view == 'day' %}active{% endif %}">
                            Ngày
                        </button>
                        <button type="submit" name="view_mode" value="week" 
                                class="btn btn-outline-primary {% if current_view == 'week' %}active{% endif %}">
                            Tuần
                        </button>
                        <button type="submit" name="view_mode" value="all" 
                                class="btn btn-outline-secondary {% if current_view == 'all' %}active{% endif %}">
                            Toàn bộ
                        </button>
                    </div>
                </form>
            </div>

            <!-- 3. Chú thích -->
            <div class="filter-group border-start ps-3 d-none d-lg-flex">
                <small class="text-muted fst-italic">
                    <span class="role-badge role-main">C</span> = Chính &nbsp;
                    <span class="role-badge role-sub">P</span> = Phụ
                </small>
            </div>
        </div>

        <!-- BẢNG LỊCH (SHIFT-BASED MATRIX) -->
        <div class="matrix-table-wrapper">
            <table class="matrix-table table-hover" id="scheduleTable">
                <thead>
                    <tr>
                        <!-- Cột Tiêu đề Ca -->
                        <th class="matrix-doctor-name text-center bg-light" style="width: 150px; min-width: 150px;">
                            CA TRỰC
                        </th>
                        
                        <!-- Header Ngày -->
                        {% for date in date_range %}
                            {% set weekday = date.weekday() %}
                            <th class="matrix-header-day 
                                       {% if weekday == 5 %}day-sat{% endif %} 
                                       {% if weekday == 6 %}day-sun{% endif %}">
                                <div class="small text-uppercase text-muted">
                                    {{ ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'CN'][weekday] }}
                                </div>
                                <div class="fs-6 text-dark">{{ date.strftime('%d/%m') }}</div>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <!-- Định nghĩa 3 ca trực chuẩn -->
                    {% set shifts_def = [
                        ('Sáng', 'Ca Sáng', '06:00 - 14:00', 'text-warning', 'bi-brightness-alt-high-fill'),
                        ('Chiều', 'Ca Chiều', '14:00 - 22:00', 'text-info', 'bi-sunset-fill'),
                        ('Đêm', 'Ca Đêm', '22:00 - 06:00', 'text-secondary', 'bi-moon-stars-fill')
                    ] %}

                    {% for keyword, label, hours, color_class, icon in shifts_def %}
                    <tr>
                        <!-- Header Hàng: Tên Ca + Giờ -->
                        <th class="matrix-doctor-name bg-white text-center align-middle">
                            <div class="fs-6 fw-bold {{ color_class }}">
                                <i class="bi {{ icon }}"></i> {{ label.upper() }}
                            </div>
                            <div class="small text-muted">{{ hours }}</div>
                        </th>
                        
                        <!-- Các ô ngày -->
                        {% for date in date_range %}
                            <td class="matrix-cell">
                                <div class="d-flex flex-column gap-1">
                                    {% for doctor in doctors_list %}
                                        {% set assign = assignments_map[doctor.id].get(date) %}
                                        <!-- Kiểm tra nếu bác sĩ có lịch vào ngày này VÀ tên ca chứa từ khóa (Sáng/Chiều/Đêm) -->
                                        {% if assign and keyword in assign.shift_name %}
                                            <div class="doctor-badge clinic-item clinic-{{ doctor.clinic_id if doctor.clinic_id else 'none' }} 
                                                        {% if doctor.role.value == 'Chính' %}border-primary{% else %}border-secondary{% endif %}"
                                                 style="background-color: {% if doctor.role.value == 'Chính' %}#e7f1ff{% else %}#f8f9fa{% endif %}; 
                                                        border-left: 3px solid {% if doctor.role.value == 'Chính' %}#0d6efd{% else %}#6c757d{% endif %};
                                                        padding: 4px 6px; border-radius: 4px; font-size: 0.85em; text-align: left; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                                
                                                <!-- Tên Bác sĩ -->
                                                <span class="fw-bold text-dark">{{ doctor.name }}</span>
                                                
                                                <!-- Vai trò -->
                                                {% if doctor.role.value == 'Chính' %}
                                                    <span class="text-primary fw-bold float-end" style="font-size: 0.8em;">(C)</span>
                                                {% else %}
                                                    <span class="text-muted fw-bold float-end" style="font-size: 0.8em;">(P)</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Footer đếm số lượng -->
        <div class="mt-3 d-flex justify-content-between text-muted small">
            <div>
                Đang hiển thị <span id="visibleCount" class="fw-bold text-dark">--</span> lượt trực.
            </div>
            <div>
                <i class="bi bi-info-circle"></i> <strong>Mẹo:</strong> Sử dụng bộ lọc "Khoa" để dễ dàng kiểm tra định biên (2 Chính, 1 Phụ).
            </div>
        </div>

    {% endif %}

    <div class="mt-4 mb-5">
        <a href="{{ url_for('main.schedule_dashboard') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại
        </a>
    </div>
</div>

<!-- JAVASCRIPT LỌC KHOA (Client-side) -->
<script>
    function filterSchedule() {
        const filterValue = document.getElementById('clinicFilter').value;
        const items = document.querySelectorAll('.clinic-item');
        let visibleCount = 0;

        items.forEach(item => {
            // Nếu chọn "all", hiện tất cả
            if (filterValue === 'all') {
                item.style.display = 'block'; 
                visibleCount++;
            } 
            // Nếu chọn khoa cụ thể
            else {
                if (item.classList.contains(filterValue)) {
                    item.style.display = 'block'; // Hiện nếu trùng class clinic-{id}
                    visibleCount++;
                } else {
                    item.style.display = 'none'; // Ẩn nếu không trùng
                }
            }
        });
        
        // Cập nhật số lượng hiển thị ở footer
        document.getElementById('visibleCount').innerText = visibleCount;
    }

    // Chạy bộ lọc lần đầu khi trang vừa tải (để đếm số lượng)
    document.addEventListener('DOMContentLoaded', function() {
        filterSchedule();
    });
</script>
{% endblock %}